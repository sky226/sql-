--#1 모집단 추출: 2005-2009년동안 6개월 이내 연구약물 2번 복용한 환자.
--#1.1 combine person_id (t20) with medication table (t60)
--#1.2 6개월 이내 연구 약물 2번 복용 
--#2 결과변수: 약물 복용 중 사망한 환자 
--#2.1 combind group data with 사망 날짜 
--#2.2 마지막 약물 복용 날짜 
--#2.2.1 key_list:(2005-2013) 환자id-청구일련번호-연구약물
--#2.2.2 drug-list: combine 60t with medication list; 마지막 연구 약물 복용일을 찾기 위함. 
--#2.2.3 groups 에 마지막 약물 복용(drop_date)컬럼 추가 
--#2.3 사망컬럼 (약물복용 중 사망한 경우만 )
--#3 성향점수 매칭을 위한 정보수집
--#3.1 성별, 나이 컬럼 추가. 
--#3.2 for calculating CCI 
--#3.2.1 만능키( key_list2) : (2002-2013) 환자 id-청구일련번호-주/부상병 
--#3.2.2 주상병(40T) 합치기. 
--#3.2.3 CCI: ID-SICK (언피벗: 열->행)
--#3.3 QT 복용 갯수, QT-score 
--#3.3.1 약물정보 추출 
--#3.3.2 중복약물 제거 
--#3.3.3 QT복용 COUNT
--#3.3.4 QT-SCORE 계산

  
  --#1 모집단 추출: 2005-2013년동안 6개월 이내 연구약물 2번 복용한 환자.
--#1.1 combine person_id (t20) with medication table (t60) : list생성 2002-2013
SELECT DISTINCT a.PERSON_ID , b.KEY_SEQ, b. RECU_FR_DT, b.GNL_NM_CD INTO list  FROM  [NHID].[dbo].[NHID_GY20_T1_2002] a join [NHID].[dbo].NHID_GY60_T1_2002 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2003 a join[NHID].[dbo].NHID_GY60_T1_2003 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2004 a join[NHID].[dbo].NHID_GY60_T1_2004 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2005 a join[NHID].[dbo].NHID_GY60_T1_2005 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2006 a join[NHID].[dbo].NHID_GY60_T1_2006 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2007 a join[NHID].[dbo].NHID_GY60_T1_2007 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2008 a join[NHID].[dbo].NHID_GY60_T1_2008 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2009 a join[NHID].[dbo].NHID_GY60_T1_2009 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2010 a join[NHID].[dbo].NHID_GY60_T1_2010 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2011 a join[NHID].[dbo].NHID_GY60_T1_2011 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2012 a join[NHID].[dbo].NHID_GY60_T1_2012 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT into list select distinct a.PERSON_ID, b.KEY_SEQ, b. RECU_FR_DT,  b.GNL_NM_CD from [NHID].[dbo].NHID_GY20_T1_2013 a join[NHID].[dbo].NHID_GY60_T1_2013 b 
on a.KEY_SEQ = b.KEY_SEQ where b.GNL_NM_CD in ( '454002ATB', '454001ATB','454003ATB', '502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')

--#1.2  6개월 이내 연구 약물 2번 복용 (2005년부터): group 테이블 생성
 
--twice
SELECT PERSON_ID, KEY_SEQ, convert(date, RECU_FR_DT) as index_date, GNL_NM_CD, ROW INTO twice 
FROM ( SELECT row_number() over (partition by PERSON_ID order by RECU_FR_DT ) AS ROW, * 
		FROM list ) v 
WHERE ROW = 2 AND LEFT(RECU_FR_DT,4) >= 2005 ORDER BY PERSON_ID, RECU_FR_DT ASC
--ONCE
SELECT PERSON_ID, KEY_SEQ, convert(date, RECU_FR_DT) as fist , DATEADD( mm, 6, convert(date, RECU_FR_DT)) as six_mt, GNL_NM_CD, ROW into once 
FROM ( SELECT row_number() over (partition by PERSON_ID order by RECU_FR_DT ) AS ROW, * 
		FROM raw ) v 
WHERE ROW = 1 AND LEFT(RECU_FR_DT,4) >= 2005 ORDER BY PERSON_ID, RECU_FR_DT ASC
--TWICE <= ONCE + 6month
SELECT distinct A.PERSON_ID,A.KEY_SEQ, A.index_date, A.GNL_NM_CD as drug INTO groups    FROM twice A JOIN once B 
ON A.PERSON_ID = B.PERSON_ID AND A.GNL_NM_CD = B.GNL_NM_CD AND A.index_date <= B.six_mt ORDER BY PERSON_ID 

--ROS군 컬럼 추가. 
 ALTER TABLE groups add ros int
 update groups set ros=0
 update groups set ros =1 where drug in ( '454002ATB', '454001ATB','454003ATB') 

--drop table list 
--drop table twice
--drop table once 

--#2.결과변수: 약물 복용중 사망한 환자
--#2.1 combind group data with 사망 날짜 
--사망자 
SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date INTO #DEATH  FROM  [NHID].[dbo].[NHID_JK_2005] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2006] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2007] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2008] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2009] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2010] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2011] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2012] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''
INSERT INTO #DEATH SELECT DISTINCT A.PERSON_ID, CONVERT(DATE, CONCAT(A.DTH_YM,'01')) AS death_date FROM  [NHID].[dbo].[NHID_JK_2013] A JOIN groups B ON A.PERSON_ID = B.PERSON_ID where A.DTH_YM !=''

ALTER groups ADD death_date DATE 
UPDATE groups SET death_date =B.death_date FROM #DEATH WHERE groups.PERSON_ID = B.PERSON_ID 

--DROP TABLE #DEATH 

 --# 2.2 마지막 약물 복용 날짜
--# 2.2.1 KEY_LIST(2005-2013):ID-KEY_SEQ
SELECT DISTINCT A.PERSON_ID, A.ros,  B.KEY_SEQ AS KEYS INTO KEY_LIST1 FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2005 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2006 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2007 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2008 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2009 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2010 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2011 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2012 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 
INSERT INTO KEY_LIST1 SELECT DISTINCT A.PERSON_ID, B.KEY_SEQ AS KEYS FROM groups A JOIN [NHID].[dbo].NHID_GY20_T1_2013 B ON A.PERSON_ID =B.PERSON_ID WHERE A.index_date <= convert(date, B.RECU_FR_DT) 

--# 2.2.2 drug_lis(2005-2013):ID-SEQ-DRUG 
--combind 60t with medication list 
--로수바스타틴 군:처음과 마지막복용이 모두 로수바스타틴
SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date INTO #ROS FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2005 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB') 
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2006 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB') 
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2007 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2008 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2009 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2010 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2011 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2012 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
INSET INTO #ROS SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2013 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=1 and  B.GNL_NM_CD IN  ('454002ATB', '454001ATB','454003ATB')
--아토르바스타틴군 :처음과 마지막 복용이 모두 아토르바스타틴 
SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date INTO #ATO FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2005 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2006 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2007 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2008 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2009 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2010 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2011 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2012 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')
INSERT INTO #ATO SELECT DISTINCT A.PERSON_ID, A.ros, A.KEYS, B.GNL_NM_CD , CONVERT(DATE, B.RECU_FR_DT) AS drop_date FROM KEY_LIST1 A JOIN [NHID].[dbo].NHID_GY60_T1_2013 B ON B.KEY_SEQ = A.KEYS WHERE A.ros=0 and  B.GNL_NM_CD IN  ('502201ATB', '502202ATB', '502203ATB','502204ATB', '111501ATB','111502ATB','111503ATB', '111504ATB')

--마지막 약물 복용일 
SELECT PERSON_ID, MAX(drop_date) as last_date INTO #MAX 
FROM (
	SELECT * FROM #ROS
	UNION 
	SELECT * FROM #ATO ) B 
GROUP BY PERSON_ID 

--#2.2.3 groups 에 마지막 약물 복용(drop_date)컬럼 추가 

ALTER TABLE groups add drop_date date
UPDATE groups set drop_date =DATEADD(dat, 7, B.last_date) FROM #MAX B WHERE groups.PERSON_ID = B.PERSON_ID 

--#2.3 사망컬럼 (약물복용 중 사망한 경우만 )
--death: death_date <= drop_date
ALTER TABLE groups add death int
UPDATE groups SET death =0
UPDATE groups SET death =1 where death_date <= drop_date 

--drop table #ROS
--DROP TABLE #ATO
--DROP TABLE #MAX
--DROP TABLE #KEY_LIST1

--#3 성향점수 매칭을 위한 정보 수집.  
--#3.1 성별, 나이 컬럼 추가(JK) 
SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP INTO #person from [NHID].[dbo].[NHID_JK_2005] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2006] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2007] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2008] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2009] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2010] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2011] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2012] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 
INSERT INTO #person SELECT DISTINCT A.PERSON_ID, A.SEX, A. AGE_GROUP from [NHID].[dbo].[NHID_JK_2013] A JOIN groups B ON A.PERSON_ID =B.PERSON_ID AND A.STND_Y = LEFT(B.index_date, 4) 

--combind groups with #person
SELECT * FROM groups A LEFT JOIN #person B ON A.PERSON_ID= B.PERSON_ID 
--NULL값 확인 
SELECT * FROM groups WHERE SEX IS NULL OR AGE_GROUPS IS NULL 
--DROP TABLE #person

--#3.2 for calculating CCI
--#3.2.1 KEY_LIST2 (2002-2013) 인덱스 3년 이전 ID-청구번호-주/부상병 (GROUP-20T)
SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK INTO KEY_LIST2 FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2002 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2003 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2004 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2005 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2006 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2007 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2008 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2009 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2010 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2011 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2012 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date
INSET INTO KEY_LIST2 SELECT DISTINCT A.PERSON_ID,B.KEY_SEQ, B.MAIN_SICK, B.SUB_SICK FROM groups A JOIN  [NHID].[dbo].NHID_GY20_T1_2013 B ON A.PERSON_ID = B.PERSON_ID WHERE DATEADD(YEAR, -3, A.index_date) <= CONVERT(DATE, b.RECU_FR_DT) AND CONVERT(DATE, B.RECU_FR_DT) <= A.index_date

--#3.2.2 주상병(40T) 합치기.

SELECT DISTICT A.PERSON_ID, A.KEY_SEQ, B.SICK_SYM INTO #S FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2002 C ON A.KEY_SEQ=C.KEY_SEQ 
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2003 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2004 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2005 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2006 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2007 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2008 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2009 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2010 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2011 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2012 C ON A.KEY_SEQ=C.KEY_SEQ
INSERT INTO #S SELECT DISTINCT  A.PERSON_ID,  A.KEY_SEQ, C.SICK_SYM  FROM KEY_LIST2 A JOIN [NHID].[dbo].NHID_GY40_T1_2013 C ON A.KEY_SEQ=C.KEY_SEQ

ALTER TABLE  KEY_LIST2 ADD SICK_SYM varchar(50)
UPDATE KEY_LIST2 SET SICK_SYM =B.SICK_SYM FROM #S B WHERE KEY_LIST2.PERSON_ID = B.PERSON_ID AND KEY_LIST2.KEY_SEQ = B.KEY_SEQ
--#3.2.3 CCI:ID-SICK (언피벗: 열-> 행)
SELECT DISTINCT UNPVT.PERSON_ID, SICK INTO CCI FROM KEY_LIST2 
UNPIVOT (SICK FOR disease IN (MAIN_SICK, SUB_SICK, SICK_SYM) AS UNPVT
WHERE SICK !='' ORDER BY PERSON_ID 
--DROP TABLE #S

--#3.3 QT약물복용 갯수, QT-SCORE
--#3.3.1 약물정보 추출 (KEY_LIST2-60T)
SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD INTO #DRUG FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2002 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2003 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2004 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2005 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2006 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2007 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2008 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2009 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2010 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2011 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2012 B ON a.KEY_SEQ = B.KEY_SEQ  
INSERT INTO #DRUG SELECT DISTICT A.PERSON_ID, B.GNL_NM_CD FROM KEY_LIST2 JOIN [NHID].[dbo].NHID_GY60_T1_2013 B ON a.KEY_SEQ = B.KEY_SEQ  
---#3.3.2 중복 약물 제거 
SELECT DISTINCT PERSON_ID, GNL_NM_CD INTO #DRUG2 FROM #DRUG1 
--#3.3.3 COUNT QT약물 
SELECT * , CASE WHEN GNL_NM_CD IN ('107401ATB', '107402BIJ', '107430BIJ', '147501ACH', '159301ATB', '159302ATB', '159330BIJ', '159331BIJ', '218101ACH', '218102BIJ', '219501ATB', '219502ATB', '219503ACR', '219504ACR', '219505ACR', '219530BIJ', '222001ATB', '222002ATB', '230401ATB', '230402ATB', '230402BIJ', '230403ATB', '501901BIJ', '501902BIJ', '597401ATB','550401ATB', '550402ATB','357101ATB', '357102ACR', '357102ATB', '357103ACR', '357103ATR', '493801ATB', '493801ATD', '493802ATB', '493802ATD', '655601ATB', '655602ATB', '657401ATB', '657402ATB','131601ATB', '171601ATB', '171602ATB', '171701ATB', '171702ATB', '171703ATB', '171704ATB', '171705ATB', '189101ATB', '217701ATB','626901ATB','159901ASY', '159902ACH', '159902BIJ', '159903ACH', '159903ATB', '159904ACH', '159904BIJ', '159905ACH', '159905ATB', '159906CCM', '159930CCM', '159931BIJ', '159932CCM', '159933BIJ', '159934ASY', '179101ACH', '179101ATB', '179102ALQ', '179103ATB', '179103BIJ', '179104ATB', '179105ACH', '179130BIJ', '179131ALQ', '179601ATB', '179602CCM', '179602CLQ', '179602CMS', '179630CCM', '179631CCM', '179632CCM', '179633CCM', '179634CCM', '179635CCM', '179636CCM', '456501ATB', '456501BIJ', '456502ATB', '566201ASS', '566202ATE', '566230ASS'
,'134101ATB', '134101BIJ', '134102COO', '134102COS', '134103ACH', '134103ATB', '134104BIJ', '134105ATB', '134105ATR', '134106BIJ', '134107CLQ', '134108ATR', '134108BIJ', '134109ATB', '134110BIJ', '134130CLQ', '134132COS', '134133BIJ', '134134BIJ', '134135BIJ', '134903ATB', '183201ATB', '183202ATB', '183202BIJ', '183203ATB', '183203BIJ', '183204COS', '183205ATB', '183205BIJ', '183206BIJ', '183208COS', '183209COS', '183210COS', '183211COS', '183230COS', '183231COS', '183232COS', '183233BIJ', '183234BIJ', '183235BIJ', '183236BIJ', '183238COS', '183239COS', '183240COS', '183241COS', '183242COS', '183243COS', '203901ATB', '203902BIJ', '203903COO', '203903COS', '203904ATB', '203906CLQ', '203907ATB', '203907BIJ', '203908COS', '203909COS', '203910COS', '203911COS', '203912COS', '203930COS', '203931COS', '203932CLQ', '203932COS', '203933COS', '203934COO', '203935COO', '203936CLQ', '203936COS', '203937COS', '203938COO', '203939CLQ', '203939COS', '203940BIJ', '203941COS', '203942COS', '203943COS', '230701ATB', '230702ATB', '334100CLQ', '334100CSS', '380301ATB', '380302BIJ', '380302COS', '380303BIJ', '380304COS', '380305COS', '380306COS', '380330COS', '380331COS', '380332COS', '380333COS', '380334COS', '380335BIJ', '380336COS', '380337COS', '416401COS', '428901ATB', '428902ATB', '434501BIJ', '434801ATB', '434802COS', '434803ATB', '434830COS', '457900COS', '457900CSS', '475900CLQ', '542000CSS', '542100CSS', '542200CSS', '542300CSS', '542400CLQ', '637101ATB', '801601BIJ','151001ACH', '151002ATB', '151003ACH', '151004ACH', '200101ACH', '200101ATB', '200102APD', '226001ACS', '248100ATB', '548100ATB', '617801ATB', '677800ATB','134901ATB', '134902BIJ', '134903ASY', '134904ATB', '134904ATR', '134905ASY', '134930ASY', '134931ASY', '134932ASY', '134933ASY', '134934ASY', '134935ASY', '134936ASY', '134937ASY', '134938ASY', '134939ASY', '134940ASY', '134941ASY', '134942ASY', '153501ACH', '153501ATB', '153502ASY', '153530ASY', '153531ASY', '153532ASY', '153601AGN', '153601ATB', '153602AGN', '153602ATB', '153701ATB', '153702ATB', '153801ATB', '153901ACH', '154001ACE', '154001ACH', '154001ATB', '154002ACH', '154003ACE', '154003ACH', '154101BIJ', '154102BIJ', '154103BIJ', '225301ATB', '225302AGN', '225302ASS', '225302ATB', '225303ATB', '225304ASS', '225330AGN', '225331AGN', '225332ASS', '225333AGN', '225334AGN', '225335AGN', '225336AGN', '225337AGN', '331200COO', '331200COS', '363801CCM', '363801CLQ', '363802CCM', '363802CLQ', '363802COM', '363803CLQ', '363804CDS', '363805CDS', '363806COO', '381900CCM', '381900CLQ', '414400CLQ', '452201COO', '455901ATB', '480700ASY', '537700COO', '537800COS', '557600CCM', 'A14200CEM', 'C77900CCM','111201ATB', '172101ATB', '172102BIJ', '172103ASY', '172104ATB', '172104BIJ', '172105ATB', '172106ASY', '172130ASY', '235901ATB', '235902ASS','122701ATB', '122702ATB', '161401BIJ', '161402BIJ', '161403BIJ', '161404BIJ', '161430BIJ', '161431BIJ', '161432BIJ', '205801BIJ', '205802BIJ', '205803BIJ', '205804BIJ', '205805BIJ', '205806BIJ', '205830BIJ', '205832BIJ', '205833BIJ', '205834BIJ', '234801ACH', '234802BIJ', '242101ATB', '242102ATB', '309600ACE', '309600AGN', '309600APD', '309700ACH', '309800AGN', '364100AGN', '375900AGN', '382101CCM', '452400ACH', '452500ACH', '487701ACH', '487702ACH', '487703ACH', '488001ATB', '493301ATB', '493302ATB', '493303ATB', '493304ATB', '493305ATB', '507501ATB', '562601ACH', '562602ACH', '588401BIJ', '588430BIJ', '611801ATB', '611802ATB', '614601BIJ', '614602BIJ', '617501ACH', '617502ACH', '618101ACH', '620501ATB', '621301BIJ', '621330BIJ', '624101ATB', '624102ATB', '637300CLQ', '645201ACH', '645202ACH', '652501ATB', '652502ATB', '676501BIJ', 'A46500CLQ'
,'130801ASY', '130830ASY', '130831ASY', '130832ASY', '130833ASY', '219801BIJ', '219802BIJ', '219803BIJ', '219804BIJ', '219805BIJ', '219806BIJ', '219807BIJ', '219808BIJ', '219830BIJ', '219831BIJ', '219832BIJ', '219833BIJ', '219834BIJ', '219835BIJ', '219836BIJ', '219837BIJ', '219838BIJ', '219839BIJ','120201BIJ', '120202BIJ', '120203CPC', '120204CPC', '120205CPC', '120230BIJ', '120231CPC', '120232CPC', '120233CPC', '120234CPC', '120235CPC', '120236CPC', '313200ATB', '371600ATB', '371700ATB', '371800ATB', '518200ATB', '518300ATB','163101ACH', '163101ASY', '163101ATB', '163102CSI', '163104ASY', '163104ATB', '163105CSI', '163130ASY', '163131ASY', '225801CSI', '225802CSI', '225803CSI', '235801ATB', '235802BIJ', '235803CSI', '235804ASY', '235805CLQ', '235806ATB', '235806ATR', '235830CLQ', '334500CSI', '334600CSI', '334700CSI', '391800CSI', '407100CSI', '407200CSI', '407300CSI', '441700COS', '441700CSI', '453400CSI', '502000CSI', '506400CSI', '506500CSI', '506600CSI', '525700CSI', '525800CSI', '526200CSI', '542800CSI', '542900CSI', '543000CSI', '543100CSI', '543200CSI', '543300CSI', '543400CSI', '543500CSI', '543600CSI', '543800CSI', '543900CSI', '544000CSI', '544100CSI', '544200CSI', '544300CSI', '544400CSI', '544500CSI', '611901CSI', '611902CSI', '631200CSI', '635300CSI', '636700CSI', '636800CSI', '639900CAE', '640000CAE', '640400CSI', '643700CSI', '657900CSI', '672200CSI', '681000CSI', '681100CSI', '681200CAE', '683800CSI', '800100CSI', '801100CSI','185101ASY', '185102ACH', '185102ACS', '185102ATB', '185201ATB', '291500ACH', 'A40700ATB','150201BIJ', '150202BIJ', '150203BIJ', '167301ATB', '167301ATD', '167301BIJ', '167302ALQ', '167303BIJ', '167330BIJ', '167331BIJ', '204601ATB', '204601ATD', '204602BIJ', '204603ATB', '204603ATD', '204604BIJ', '204605BIJ', '204606ASY', '204630BIJ', '204631BIJ', '204632BIJ', '414601BIJ', '414602ATB', '414603BIJ', '414604ATB', '414630BIJ', '414631BIJ', '505701CPC','134201ATB', '134202ASS', '134203ATB', '134204ALQ', '134204APD', '134204ATB', '134301ATB', '134302ATB', '134303ATB', '148401ALQ', '148402AGN', '148402APD', '148402ATB', '148402ATL', '148403ASS', '148404ASY', '148405AGN', '148430ALQ', '148431APD', '148432ASS', '148433AGN', '148501ATB', '193701ACH', '193701ATB', '193702BIJ', '193703BIJ', '193704APD', '193705ALQ', '193706CSI', '193707CSI', '193708ATR', '193709ALQ', '193710ALQ', '193730BIJ', '193801ATR', '294600ATB', '294700ATB', '294900ATB', '295500ATB', '295800ATB', '367400ATB', '398300APD', '405600APD', '410100ATB', '461700ATB', '461700ATE', '569400ACM', 'A31300ALQ', 'B49500ALQ','120301CSI', '120403CSI', '120404BIJ', '167201BIJ', '167202BIJ', '182601BIJ', '182602BIJ', '182603BIJ', '182604BIJ', '182605BIJ', '182606BIJ', '182607BIJ', '182608BIJ', '182609BIJ', '182610BIJ', '182611BIJ', '182630BIJ', '244901BIJ', '244902BIJ', '244930BIJ', '467501BIJ', '467502BIJ', '624401BIJ', '624402BIJ','148601ATB', '148601ATD', '148602ATB', '148602ATD', '148603ATB', '483701ATB', '615201ACH', '643401ATD', '643402ATD','131901ATB', '131902BIJ', '131903ATB', '131904BIJ', '131905ATB', '131906BIJ', '131907ATB', '131908ATB', '137501ATB', '137502ATB', '137503ATB', '137504ATB', '161601BIJ', '161701ATB', '161702ATB', '161703ASY', '161704ATB', '167901ATB', '167902BIJ', '167903ATB', '167904ATB', '167905ATB', '167906ATB', '167907ATB', '167908ATB', '167909ATB', '167930BIJ', '168001BIJ', '168030BIJ', '183501ATB', '189801ATB', '189802ATB', '204001ATB', '204001ATD', '204001BIJ', '204002ATB', '204002ATD', '204003ATB', '204004ATB', '204005ATB', '211401ATB', '211402BIJ', '211403BIJ', '212401ATB', '212402ATB', '224201ALQ', '224201ATB', '224201ATD', '224202ALQ', '224202ATB', '224202ATD', '224203ATB', '224204ALQ', '224204ATB', '224204ATD', '224205BIJ', '224206BIJ', '224207ATB', '224208BIJ', '233401ATB', '233402ACH', '233403ATB', '238001ATB', '238002ATB', '238003ATB', '238004ATB', '238801ATB', '238801BIJ', '256600ACH', '378601ATB', '378602ATB', '378603ATB', '378604ATB', '378605ATB', '378605ATR', '378606ATR', '378607ATR', '378608ATR', '378609ATR', '378610ATB', '420002ATB', '420003ALQ', '420003ATB', '420004ATB', '451501ATB', '451501ATD', '451502ATB', '451502ATD', '451503ATB', '451503ATD', '451504ATB', '451505ATB', '451506BIJ', '451507BIJ', '464901ACH', '464902ACH', '464903ACH', '464904ACH', '503201ATR', '503202ATR', '503203ATR', '503204ATR', '570201BIJ', '586401BIJ', '586402BIJ', '586403BIJ', '586404BIJ', '586405BIJ', '586430BIJ', '586431BIJ', '586432BIJ', '586433BIJ', '586434BIJ', '586435BIJ', '586436BIJ', '586437BIJ', '586438BIJ'
,'107501ACR', '107501ATB', '107502ACR', '107502ATB', '107503ACR', '107504ATB', '108001ATB', '108002ATB', '136301ACH', '136301ATB', '136302ACH', '136302ATB', '136303ACH', '136304ATB', '149201ACH', '149202ACH', '149203ATB', '149204ATB', '173701ATB', '188101ATB', '188102ATB', 
'188103ATB', '188104ATB', '451901CCM','161501ACH', '161501ATB', '161502ACH', '161502ATB', '161502ATD', '161502ATR', '161503ASY', '161504ACR', '161505ACH', '162501ATB', '162502ATB', '209301ATB', '209302ATB', '209303ATB', '209304ATE', '209304ATR', '209305ATE', '209305ATR',
'209306ATR', '227001ATB', '227002ATB', '227003ATB', '428301ATB', '474801ATB', '474802ATB', '474803ATB', '474804ATB', '521101ATD', '521102ATD','133201ACR', '133201ATB', '133201ATD', '133201ATR', '133202APD', '133202ATB', '133202ATD', '133203ACR', '133203ATR', '133204ATR',
 '457401ATB', '457402ATB', '457403ATB', '506100ATB') THEN 1 ELSE 0 END AS QT 
 INTO #QT FROM #DRUG2 

 --#3.3.4 QT약물 갯수, QT-SCORE 계산

SELECT PERSON_ID, SUM(QT) AS QT, 
		CASE WHEN SUM(QT) =0 THEN 0
             WHEN SUM(QT)>=1 AND SUM(QT) < 4 THEN 1 
             WHEN SUM(QT) >= 4 THEN 2 
             END AS QT_SCORE
INTO #QT_2 FROM #QT GROUP BY PERSON_ID 
--group table에 QT, QT-SCORE 컬럼 추가

ALTER TABLE groups ADD QT INT
ALTER TABLE groups ADD QT_SCORE INT

UPDATE groups SET QT =B.QT WHERE #QT_2 B WHERE groups.PERSON_ID = B.PERSON_ID 
UPDATE groups SET QT_SCORE =B.QT_SCORE FROM #QT_2 B WHERE groups.PERSON_ID = B.PERSON_ID  

--DROP TABLE #DRUG
--DROP TABLE #DRUG2
--DROP TABLE #QT
--DROP TABLE #QT_2